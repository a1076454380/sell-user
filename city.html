<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title></title>
		<script src="js/rem.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="css/reset.css" />
		<link rel="stylesheet" type="text/css" href="css/main.css" />
		<script src="js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://cdn.bootcss.com/vue/2.5.9/vue.min.js"></script>
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.4&key=3adc59b361b877d943cda0ce50b9b4da"></script>
		<script src="http://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
	</head>
	<style type="text/css">
		select {
			border: 1px solid #DDD8CE!important;
		}
		
		#mainMap {
			width: 100%;
			height: 100%;
		}
	</style>

	<body>
		<div id="app" class="wrapper city">
			<div class="layui" v-show="layui">
				<div class="layui-inner">
					<div class="layui-top">
						友情提示
					</div>
					<div class="layui-main">
						{{layuitext}}
					</div>
					<div class="layui-settings">
						<div class="layui-setting" @click="layuiboo">
							确定
						</div>
					</div>
				</div>
			</div>
			<header class="header">
				<span class="header-back mui-action-back">
					<img src="img/back.png"/>
				</span>
				<span class="header-main">地址选择</span>
				<span class="header-settings" @click="opennew()">确定</span>
			</header>
			<div class="main" style="height: calc(100% - .8rem);">
				<div id="mainMap"></div>
			</div>
		</div>
		<script type="text/javascript">
			var myvue = new Vue({
				el: '#app',
				data: {
					layui: false,
					layuitext: ''
				},
				methods: {
					opennew:function(){
						mui.openWindow({
							url:'./index.html',
							id:'index',
							createNew: true
						})
					},
					layuiboo: function() {
						this.layui = !this.layui
					}
				},
				mounted: function() {
					// 实例化地图， 命名定位插件实例、标记实例、地理编码实例、输出变量
					var map = new AMap.Map('mainMap', {
						resizeEnable: true,
						zoom: 16,
					});
					geolocation = null;
					Marker = null;
					geocoder = null;
					result = document.getElementById('resultMapInfo');
					// 移动中
					AMap.event.addListener(map, 'dragging', function() {
						Marker.setPosition(map.getCenter())
					});
					// 停止移动
					AMap.event.addListener(map, 'dragend', function() {
						// 利用地图地理编码查询地址
						geocoder.getAddress(map.getCenter(), function(status, data) {
							if(status === 'complete' && data.info === 'OK') {
								//中心点坐标
								localStorage.setItem('lng', map.getCenter().getLat())
								localStorage.setItem('lat', map.getCenter().getLng())
								var lnglatXY = [map.getCenter().getLng(), map.getCenter().getLat()]; //地图上所标点的坐标
								geocoder.getAddress(lnglatXY, function(status, result) {
									if(status === 'complete' && result.info === 'OK') {
										localStorage.setItem('province', result.regeocode.addressComponent.province)
										localStorage.setItem('city01', result.regeocode.addressComponent.city)
										localStorage.setItem('area', result.regeocode.addressComponent.district)
										localStorage.setItem('city', result.regeocode.addressComponent.province + result.regeocode.addressComponent.city)
										localStorage.setItem('city02', result.regeocode.addressComponent.province + result.regeocode.addressComponent.city + result.regeocode.addressComponent.district)
										plus.nativeUI.toast('地址已修改')
									} else {
										//获取地址失败
										that.city = '获取失败'
									}
								});
							} else {
								//获取地址失败
								var str = '<p>定位失败</p>';
								str += '<p>错误信息：'
								switch(data.info) {
									case 'INVALID_UESR_KEY':
										str += '用户key非法或过期';
										break;
									case 'SERVICE_UNAVAILABLE':
										str += '请求服务不可用';
										break;
									case 'INSUFFICIENT_PRIVILEGES':
										str += '无权限访问此服务';
										break;
									case 'INVALID_PARAMS':
										str += '请求参数非法';
										break;
									default:
										str += '无网络或其他未知错误';
										break;
								}
								str += '，请重新获取当前位置。</p>';
								result.innerHTML = str;
							}
						});

						Marker.setPosition(map.getCenter())
						Marker.setAnimation('AMAP_ANIMATION_DROP')
					});

					// 加载地理位置编码插件
					AMap.service('AMap.Geocoder', function() { //回调函数
						//实例化Geocoder
						geocoder = new AMap.Geocoder({
							city: "010" //城市，默认：“全国”
						});
						//TODO: 使用geocoder 对象完成相关功能
					});
					// 加载定位插件

					map.plugin('AMap.Geolocation', function() {
						// 初始化定位插件
						geolocation = new AMap.Geolocation({
							enableHighAccuracy: true, //是否使用高精度定位，默认:true
							timeout: 10000, //超过10秒后停止定位，默认：无穷大
							maximumAge: 0, //定位结果缓存0毫秒，默认：0
							convert: true, //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
							showButton: true, //显示定位按钮，默认：true
							buttonPosition: 'LB', //定位按钮停靠位置，默认：'LB'，左下角
							buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
							showMarker: false, //定位成功后在定位到的位置显示点标记，默认：true
							showCircle: false, //定位成功后用圆圈表示定位精度范围，默认：true
							panToLocation: true, //定位成功后将定位到的位置作为地图中心点，默认：true
							zoomToAccuracy: true //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
						});
						// 把定位插件加入地图实例
						map.addControl(geolocation);

						// 添加地图全局定位事件
						AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
						AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息

						// 调用定位
						geolocation.getCurrentPosition();

					});

					/*
					 *解析定位结果
					 */
					function onComplete(data) {
						Marker = null;
						if(Marker) {
							// 标记存在则把地图中心点设置给标记
							Marker.setPosition(map.getCenter())
							Marker.setAnimation('AMAP_ANIMATION_DROP')
						} else {
							// 标记不存在则实例化一个新的标记，且把当前地图中心点设置给标记
							Marker = new AMap.Marker({
								position: map.getCenter(),
								animation: 'AMAP_ANIMATION_DROP'
							});
							// 把标记加入地图实例
							Marker.setMap(map);
						}
					};
					/*
					 *解析定位错误信息
					 */
					function onError(data) {
						var str = '<p>定位失败</p>';
						str += '<p>错误信息：'
						switch(data.info) {
							case 'PERMISSION_DENIED':
								str += '浏览器阻止了定位操作';
								break;
							case 'POSITION_UNAVAILBLE':
								str += '无法获得当前位置';
								break;
							case 'TIMEOUT':
								str += '定位超时';
								break;
							default:
								str += '无网络或其他未知错误';
								break;
						}
						str += '，请重新获取当前位置。</p>';
						// 初始化标记
						if(Marker) {
							// 标记存在则把地图中心点设置给标记
							Marker.setPosition(map.getCenter())
							Marker.setAnimation('AMAP_ANIMATION_DROP')
						} else {
							// 标记不存在则实例化一个新的标记，且把当前地图中心点设置给标记
							Marker = new AMap.Marker({
								position: map.getCenter(),
								animation: 'AMAP_ANIMATION_DROP'
							});
							// 把标记加入地图实例
							Marker.setMap(map);
						}
						result.innerHTML = str;
					};
				},
				update: function() {

				}
			})
		</script>
	</body>

</html>