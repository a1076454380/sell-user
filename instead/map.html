<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title></title>
		<script src="../js/rem.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/reset.css" />
		<link rel="stylesheet" type="text/css" href="../css/main.css" />
		<script src="../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://cdn.bootcss.com/vue/2.5.9/vue.min.js"></script>
		<script src="http://static.runoob.com/assets/jquery-validation-1.14.0/lib/jquery.js"></script>
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.4&key=3adc59b361b877d943cda0ce50b9b4da"></script>
		<script src="http://webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
	</head>
	<style type="text/css">
		.main {
			height: 100%;
			padding: 1.6rem 0 0;
		}
		.header{overflow: initial;}
	</style>

	<body>
		<div id="app" class="wrapper instead map">
			<div class="layui" v-show="layui">
				<div class="layui-inner">
					<div class="layui-top">
						友情提示
					</div>
					<div class="layui-main">
						{{layuitext}}
					</div>
					<div class="layui-settings">
						<div class="layui-setting" @click="layuiboo">
							确定
						</div>
					</div>
				</div>
			</div>
			<header class="header">
				<span class="header-back mui-action-back">
						<img src="../img/back.png"/>
					</span>
				<span class="header-main">
					<input type="text" id="pickerInput" class="box-size" placeholder="输入需要搜索的地址"/>
				</span>
				<span class="header-settings">
					
				</span>
			</header>
			<div class="main" id="l-map">
				<div class="pickerInput">
					
					<input type="text" class="box-size" placeholder="搜索地址" readonly="" v-model="adress"/>
					<input type="text" class="box-size" placeholder="请输入详细地址" v-model="detail"/>
					<div>
						<input type="text" class="box-size" placeholder="请输入姓名"  v-model="name"/>
						<input type="number" class="box-size" placeholder="请输入手机号"  v-model="phone"/>
					</div>
				</div>
				<div class="mysub" @click="opennew">
					确定
				</div>
			</div>
		</div>
		<script type="text/javascript">
			var myvue = new Vue({
				el: '#app',
				data: {
					layui: false,
					layuitext: '信息未填写完整',
					adress:'',
					detail:'',
					name:'',
					phone:''
				},
				methods: {
					layuiboo: function() {
						this.layui = !this.layui
					},
					opennew: function() {
						if(this.adress==''||this.detail==''||this.name==''||this.phone==''){
							this.layuitext='信息未填写完整'
							this.layuiboo()
						}else{
							if((/^1[3|4|5|8|7][0-9]\d{4,8}$/.test(this.phone))){
								localStorage.setItem(localStorage.getItem('maptype')+'adress',this.adress)
								localStorage.setItem(localStorage.getItem('maptype')+'detail',this.detail)
								localStorage.setItem(localStorage.getItem('maptype')+'name',this.name)
								localStorage.setItem(localStorage.getItem('maptype')+'phone',this.phone)
								mui.openWindow({
									url: 'instead.html',
									id: 'instead'
								})
							}else{
								this.layuitext='手机号格式错误'
								this.layuiboo()
							}
						}
					}
				},
				mounted: function() {
					var that = this
//					document.addEventListener('plusready', onPlusReady, false);
//					function onPlusReady() {
//						plus.geolocation.getCurrentPosition(function(p) {
							var mapcenter =  [116.39, 39.9]
							var map = new AMap.Map('l-map', {
								zoom: 15,
								center: mapcenter
							});
							var info = []
							AMap.service('AMap.Geocoder', function() { //回调函数
								//实例化Geocoder
								geocoder = new AMap.Geocoder({
									//								city: "" 城市，默认：“全国”
								});
								//根据经纬度查地址
								geocoder.getAddress(mapcenter, function(status, result) {
									if(status === 'complete' && result.info === 'OK') {
										info.push(result.regeocode.formattedAddress)
										that.adress = result.regeocode.formattedAddress
										var infoWindow = new AMap.InfoWindow({
											content: info.join("<br>") //使用默认信息窗体框样式，显示信息内容
										});
										infoWindow.open(map, mapcenter);
									} else {
										//获取地址失败
									}
								})
							})
							AMap.plugin(['AMap.Autocomplete', 'AMap.PlaceSearch'], function() {
								var autoOptions = {
									input: "suggestId" //使用联想输入的input的id
								};
								autocomplete = new AMap.Autocomplete(autoOptions);
								var placeSearch = new AMap.PlaceSearch({
									map: map
								});
								AMap.event.addListener(autocomplete, "select", function(e) {
									//		           TODO 针对选中的poi实现自己的功能
									placeSearch.search('金山福地')
								});
							});
							var _onClick = function(e) {
								AMap.service('AMap.Geocoder', function() {
									geocoder = new AMap.Geocoder({
										city: ""
									});
									geocoder.getAddress(e.lnglat, function(status, result) {
										if(status === 'complete' && result.info === 'OK') {
											var info = [];
											info.push(result.regeocode.formattedAddress)
											that.adress = result.regeocode.formattedAddress
											new AMap.InfoWindow({
												content: info.join("<br>") //使用默认信息窗体框样式，显示信息内容
											}).open(map, e.lnglat);
										}
									});
								})
							}
							AMap.event.addListener(map, "click", _onClick);
							AMapUI.loadUI(['misc/PoiPicker'], function(PoiPicker) {
								var poiPicker = new PoiPicker({
									//city:'北京',
									input: 'pickerInput'
								});
								//初始化poiPicker
								poiPickerReady(poiPicker);
							});

							function poiPickerReady(poiPicker) {
								window.poiPicker = poiPicker;
								var marker = new AMap.Marker();
								var infoWindow = new AMap.InfoWindow({
									offset: new AMap.Pixel(0, 0)
								});
								//选取了某个POI
								poiPicker.on('poiPicked', function(poiResult) {
									console.log(poiResult)
									var source = poiResult.source,
										poi = poiResult.item,
										info = {
											source: source,
											id: poi.id,
											name: poi.name,
											location: poi.location.toString(),
											address: poi.address
										};
									AMap.service('AMap.Geocoder', function() { //回调函数
										//实例化Geocoder
										geocoder = new AMap.Geocoder({
											city: "" //城市，默认：“全国”
										});
										geocoder.getAddress(poiResult.item.location, function(status, result) {
											if(status === 'complete' && result.info === 'OK') {
												infoWindow.setContent('地址信息: <pre>' + result.regeocode.formattedAddress + '</pre>');
												that.adress = result.regeocode.formattedAddress
												infoWindow.open(map, marker.getPosition());
											} else {
												//获取地址失败
											}
										});
									})
									infoWindow.setMap(map);
									infoWindow.setPosition(poi.location);
									map.setCenter(infoWindow.getPosition());
								});
							}
//						}, function(e) {
//							alert('Geolocation error: ' + e.message);
//						});
//					}
				},
				update: function() {
					mui.init()
				}
			})
		</script>
	</body>

</html>